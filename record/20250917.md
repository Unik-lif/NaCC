## 实验记录
出现了比较诡异的现象，每次崩的位置好像不大一样

我尝试捕获一下异常类型吧，太奇怪了

会不会是跳转到了IRQ栈上的问题？

搞不明白为什么会出这个问题，看起来regs上的设置一切ok，我们尽量再去多读几遍linux对于这个的处理

以及，我们或许可以考虑写一个很小的程序来确认这件事情

写一个死循环，然后他应该是能进入到do_irq函数中的，我们直接做捕获就行

跑起来发现确实能够正常地走完，那就说明我们在agent这边对于异常的处理还是出了一些问题

必须更加仔细地看这个过程为什么会有不同

诶，好像csr_status这东西有点说法

```shell 
# linux处理来自于user app的do_irq时钟中断，我们看到的sstatus值
Breakpoint 1, handle_exception () at /home/link/Desktop/NaCC/linux/arch/riscv/kernel/entry.S:101                                                                                              
101             csrrw tp, CSR_SCRATCH,tp
(gdb) p/x $scause                                                                                                                                                   
$1=0x8000000000000005                                                                                                                                                           
(gdb) p/x $sstatus                      
$4 = 0x200004020
(gdb) 
149             csrrc s1, CSR_STATUS, t0
(gdb) 
150             csrr s2, CSR_EPC
(gdb) p/x $sstatus   
$5 = 0x200000020

(gdb) c
Continuing.

Breakpoint 2, do_irq (regs=0xffffffc60051bee0) at /home/link/Desktop/NaCC/linux/arch/riscv/kernel/traps.c:383
383             irqentry_state_t state = irqentry_enter(regs);
(gdb) p/x $sstatus
$6 = 0x200000020

(gdb) p/x *(struct pt_regs *) regs
$39 = {epc = 0x2ad5b0f62e, ra = 0x3fadfc377c, sp = 0x3fd2e45660, gp = 0x2ad5b11800, tp = 0x3fae0d13e0, t0 = 0x3fae0da4c8, t1 = 0x3fae0e8f3c, t2 = 0x3fae0c3420, s0 = 0x3fd2e45670, s1 = 0x1, 
  a0 = 0x1, a1 = 0x3fd2e457f8, a2 = 0x3fd2e45808, a3 = 0x0, a4 = 0x3fd2e45690, a5 = 0x2ad5b0f628, a6 = 0x3fae0c3db0, a7 = 0x7c2f1e705b5c4a5b, s2 = 0x0, s3 = 0x2ad5b10e08, 
  s4 = 0x2ad5b0f628, s5 = 0x3fd2e45808, s6 = 0x2ad5b10e08, s7 = 0x3fae0fad18, s8 = 0x3fae0fb050, s9 = 0x2ac8643750, s10 = 0x2ac85dc858, s11 = 0x2ac85dc7c8, t3 = 0x3fadfa19a0, t4 = 0xef3c, 
  t5 = 0x3, t6 = 0xffffffffffffffff, status = 0x200004020, badaddr = 0x0, cause = 0x8000000000000005, orig_a0 = 0x3fae0d2000}
(gdb) n
390             irqentry_exit(regs, state);

# 但是还是有一件事情比较奇怪，同样是在跑哪个enable irq的步骤时，还是不出意料地挂了，虽然它确实可以跑到irqentry_exit这边
```
我们目前的agent处理逻辑，在sstatus寄存器上似乎确实还是有一些问题
```shell
Breakpoint 2, __trap_entry () at src/entry.S:102
102         csrrw tp, CSR_SSCRATCH, tp
(gdb) p/x $sstatus
$1 = 0x200004020

Breakpoint 2, do_irq (regs=0xffffffc600ec3b70) at /home/link/Desktop/NaCC/linux/arch/riscv/kernel/traps.c:383
383             irqentry_state_t state = irqentry_enter(regs);
(gdb) p/x $sstatus
$1 = 0x200004000
(gdb) p/x *(struct pt_regs *) regs
$2 = {epc = 0x2aabdb3c70, ra = 0x2aabe001a0, sp = 0x3f7402b6f8, gp = 0x2aac616368, tp = 0x3fbe0a2800, t0 = 0x2aac618d60, t1 = 0x0, t2 = 0x3f7403200c, s0 = 0x2aac618d60, s1 = 0x1, 
  a0 = 0xffffffffffffffda, a1 = 0x3f3c000000, a2 = 0x0, a3 = 0x0, a4 = 0x0, a5 = 0x0, a6 = 0x0, a7 = 0x101, s2 = 0x5e, s3 = 0x60, s4 = 0x30, s5 = 0x30, s6 = 0x5f, s7 = 0x4, 
  s8 = 0x2aac1ef7e8, s9 = 0x3f7402b368, s10 = 0x3f7402b6f0, s11 = 0x3f740001c0, t3 = 0x18, t4 = 0xe09e32f455c71, t5 = 0xffffffffffffffff, t6 = 0x3f74034008, status = 0x200004020, 
  badaddr = 0x0, cause = 0x8000000000000005, orig_a0 = 0x0}
```
我们把sstatus寄存器设置回去了，但是好像还是不能直接进入到我们想要进入的位置？

再确认一下，下面是正常的结果
```C
(gdb) p/x $sie
$2 = 0x222
(gdb) p/x $sip
$3 = 0x220
(gdb) p/x $sstatus
$4 = 0x200000020

542             while ((softirq_bit = ffs(pending))) {
(gdb) p/x $sip
$9 = 0x0
(gdb) p/x $sip
$10 = 0x0
(gdb) p/x $sie
$11 = 0x222
(gdb) p/x $sstatus
$12 = 0x200000022

```

```shell
(gdb) p/x $a2
$5 = 0x400140
(gdb) x/10i $pc
=> 0xffffffff8001a28c <handle_softirqs+150>:    csrsi   sstatus,2
   0xffffffff8001a290 <handle_softirqs+154>:    auipc   a7,0x15ee
   0xffffffff8001a294 <handle_softirqs+158>:    addi    a7,a7,-528
   0xffffffff8001a298 <handle_softirqs+162>:    j       0xffffffff8001a2f2 <handle_softirqs+252>
   0xffffffff8001a29a <handle_softirqs+164>:    .insn   4, 0x601d979b
   0xffffffff8001a29e <handle_softirqs+168>:    addiw   s10,a5,1
   0xffffffff8001a2a2 <handle_softirqs+172>:    sext.w  a5,a5
   0xffffffff8001a2a4 <handle_softirqs+174>:    beqz    s10,0xffffffff8001a2fc <handle_softirqs+262>
   0xffffffff8001a2a8 <handle_softirqs+178>:    lw      a4,32(tp) # 0x20
   0xffffffff8001a2ac <handle_softirqs+182>:    slli    a5,a5,0x3
(gdb) si

Breakpoint 2, do_irq (regs=0xffffffc600003df0) at /home/link/Desktop/NaCC/linux/arch/riscv/kernel/traps.c:383
383             irqentry_state_t state = irqentry_enter(regs);
(gdb) p/x *(struct pt_regs *) regs     
$6 = {epc = 0xffffffff8001a290, ra = 0xffffffff8001a802, sp = 0xffffffc600003f10, gp = 0xffffffff81718d70, tp = 0xffffffd68aa93fc0, t0 = 0x460f473, t1 = 0x2ce4, t2 = 0xffffffff8100d29c, 
  s0 = 0xffffffc600003fb0, s1 = 0xffffffff81755518, a0 = 0x0, a1 = 0xffffffd6fefe1580, a2 = 0x400140, a3 = 0xffffffd6fefe1cc0, a4 = 0xffffffd6fefe1cc0, a5 = 0xffffffff81755518, a6 = 0x1, 
  a7 = 0x1, s2 = 0xffffffff80e28238, s3 = 0xffffffff81608080, s4 = 0xa, s5 = 0xffffffff80e30cc0, s6 = 0xffffcba4, s7 = 0x4, s8 = 0x2adfdf7da0, s9 = 0x3f7402b368, s10 = 0x3f7402b6f0, 
  s11 = 0x2, t3 = 0xa, t4 = 0x460f473, t5 = 0x3f2, t6 = 0xc12c4cc9, status = 0x200000120, badaddr = 0x0, cause = 0x8000000000000005, orig_a0 = 0x3fbd623800}
(gdb) 
```

是一个嵌套中断的问题！！搞清楚了！！明天好好思考一下！今天找到问题症结了！只要能够搞清楚问题的成因！一切就有希望！