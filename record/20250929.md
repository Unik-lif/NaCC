## 实验记录
推翻了昨天的一些认知

问题很奇怪，现象的话是当我触发了一个系统调用，交给linux代理之后，scause为8，但会因为do_irq的处理返回到linux代理之后的位置，也就是跳转到trampoline位置

在aret指令中已经限制了，只有S mode才能运行它，我们得尝试分析一下这个问题的成因


```
Breakpoint 3, do_trap_ecall_u (regs=0xffffffc6007fbb70)                                                                                                                                                              at /home/link/Desktop/NaCC/linux/arch/riscv/kernel/traps.c:317                                                                                                                                               317             if (user_mode(regs)) {                                                                                                                                                                           (gdb) p/x *(struct pt_regs *) regs                                                                                                                                                                               $2 = {epc = 0x2ac3d5fe2c, ra = 0x2ac3d1e0e0, sp = 0x3fcfa8ca00, gp = 0x2ac45c5368, tp = 0x3face6e800,                                                                                                              t0 = 0x81, t1 = 0x3fcf28d3a0, t2 = 0x3f64032008, s0 = 0x1fffffffffffffff, s1 = 0x3f64033238,                                                                                                                     a0 = 0x2ac45c97a0, a1 = 0x81, a2 = 0x1, a3 = 0x0, a4 = 0x0, a5 = 0x0, a6 = 0x63fffc0c, a7 = 0x62,                                                                                                                s2 = 0x3fcfa8ca10, s3 = 0x2ac45c7d60, s4 = 0x1, s5 = 0x30, s6 = 0x5f, s7 = 0x4, s8 = 0x2ac45c7da0,                                                                                                               s9 = 0x3fcfa8ca60, s10 = 0x3f6402b6c0, s11 = 0x2ac45c6ea0, t3 = 0x18, t4 = 0xfdb9ffd07a7c,                                                                                                                       t5 = 0xffffffffffffffff, t6 = 0x1113a055f, status = 0x8000000200006020, badaddr = 0x0, cause = 0x8,                                                                                                              orig_a0 = 0x0}


(gdb) c                                                                                                                                                                                                          Continuing.                                                                                                                                                                                                                                                                                                                                                                                                                       Breakpoint 4, __save_context () at src/entry.S:226                                                                                                                                                               226         j __ret_from_exception                                                                                                                                                                               (gdb) s                                                                                                                                                                                                          __ret_from_exception () at src/entry.S:238                                                                                                                                                                       238         addi sp, sp, 32                                                                                                                                                                                      (gdb) p/x $sp                                                                                                                                                                                                    $3 = 0xffffffc6007fba00
(gdb) p/x $do_irq
$4 = void
(gdb) p/x $scause
$5 = 0x8000000000000005

(gdb) p/x $sstatus
$6 = 0x200000020

(gdb) p/x *(struct pt_regs *) ($sp + 32)
$8 = {epc = 0xffffffff80a28ed2, ra = 0x3f24000154, sp = 0xffffffc6007fbb40, gp = 0xffffffff81718d70,                                                                                                               tp = 0xffffffd68b650000, t0 = 0x3f2400016c, t1 = 0xffffffff81001198, t2 = 0x80,                                                                                                                                  s0 = 0xffffffc6007fbb70, s1 = 0xffffffc6007fbb70, a0 = 0xffffffc6007fbb70, a1 = 0x62,                                                                                                                            a2 = 0x2ac45c97a0, a3 = 0xffffffffffffffda, a4 = 0x2ac3d5fe30, a5 = 0x0, a6 = 0x63fffc0c, a7 = 0x62,                                                                                                             s2 = 0x2ac3d5fe2c, s3 = 0x0, s4 = 0x8, s5 = 0x3face6e800, s6 = 0x5f, s7 = 0x4, s8 = 0x2ac45c7da0,                                                                                                                s9 = 0x3fcfa8ca60, s10 = 0x3f6402b6c0, s11 = 0x2ac45c6ea0, t3 = 0x18, t4 = 0xfdb9ffd07a7c,                                                                                                                       t5 = 0xffffffffffffffff, t6 = 0x1113a055f, status = 0x200000120, badaddr = 0x0,                                                                                                                                  cause = 0x8000000000000005, orig_a0 = 0x1}
(gdb) p/x ($sp+ 32)
$9 = 0xffffffc6007fba20


[Qemu] Linux will return to 3f2400016c
[Qemu] Agent will jump to twin_entry! With scause 8
[Thread 0x7ffe0e000640 (LWP 793829) exited]
[  245.931125] [Linux]: Back to 'do_irq' in kernel. With regs: ffffffc600003cb0
[  245.944887] [Linux]: Back to 'do_irq' in kernel. With regs: ffffffc600003cb0
[  245.948907] [Linux]: Back to 'do_irq' in kernel. With regs: ffffffc600003d40
[  245.951769] [Linux]: Back to 'do_irq' in kernel. With regs: ffffffc6007fba20
[Qemu] Linux will return to 3f24000198
```
这里非常奇怪，总结一下奇怪的地方
- do_irq明明在恢复的时候，应该能够同时恢复掉sstatus寄存器为正确的值，但是没能恢复正确值，这个do_irq应该来源于kernel的中断位置
- 这个trampoline不应该跳转过来，切换过来的并非trap对应的上下文

思考一下这背后的成因，感觉很诡异