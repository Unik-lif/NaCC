## 实验记录
pmd对应的lock也得注意一下

查看一下pagetable_pmd_ctor和pagetable_pte_ctor之间的区别

区别仅仅在于大页情况可能出现的特殊处理流程，是比较好做的，默认的linux配置文件没有对这个做设置
```shell
(base) link@public-Super-Server:~/NaCC/riscv-linux$ grep -rn "CONFIG_TRANSPARENT_HUGEPAGE"
.config:806:# CONFIG_TRANSPARENT_HUGEPAGE is not set
.config.old:806:# CONFIG_TRANSPARENT_HUGEPAGE is not set
kernel/config_data:806:# CONFIG_TRANSPARENT_HUGEPAGE is not set
```

pmd_alloc，pte_alloc时的锁现在已经加上，不过似乎还是有一些新问题，似乎是在follow_page_pte的时候发生的
```shell
(gdb) bt
#0  follow_page_pte (vma=vma@entry=0xffffffd68813c720, address=address@entry=272731062272,
    pmd=0xffffffd73fffc000, flags=flags@entry=14, pgmap=pgmap@entry=0xffffffc6006bb4b8)
    at /home/link/NaCC/linux/mm/gup.c:833
#1  0xffffffff80188c6c in follow_pmd_mask (pudp=<optimized out>, vma=0xffffffd68813c720,
    address=272731062272, flags=14, ctx=0xffffffc6006bb4b8) at /home/link/NaCC/linux/mm/gup.c:982
#2  follow_pud_mask (vma=0xffffffd68813c720, address=272731062272, p4dp=<optimized out>, flags=14,
    ctx=0xffffffc6006bb4b8) at /home/link/NaCC/linux/mm/gup.c:1021
#3  follow_p4d_mask (vma=0xffffffd68813c720, address=272731062272, pgdp=<optimized out>, flags=14,
    ctx=0xffffffc6006bb4b8) at /home/link/NaCC/linux/mm/gup.c:1038
#4  follow_page_mask (vma=0xffffffd68813c720, address=272731062272, flags=14, ctx=0xffffffc6006bb4b8)
    at /home/link/NaCC/linux/mm/gup.c:1081
#5  __get_user_pages (mm=mm@entry=0xffffffd680fab980, start=<optimized out>, start@entry=272731062272,
    nr_pages=<optimized out>, nr_pages@entry=1, gup_flags=gup_flags@entry=14,
    pages=pages@entry=0xffffffc6006bb550, locked=locked@entry=0xffffffc6006bb54c)
    at /home/link/NaCC/linux/mm/gup.c:1483
```
出现异常的原因
```
[  162.589707] [follow_page_pte]: page: 000000002e38822b, address: 3f8c37b000, vpn[2]: 254 vpn[1]: 97 vpn[0]: 379 pte: 40000000000053, vma: 00000000d6bba07a, pmd: 0000000077dcf24b
```
看起来单纯就是这个地方没有被写入值而已，不过我没懂为什么会这样，尝试跟一下
```
page table 11d8a8000
..170: pte 6ffffc01 pa 1bffff000 [level 2]
.. ..341: pte 6fffe001 pa 1bfff8000 [level 1]
.. .. ..171: [OTHE] pte 6000004f pa 180000000 [level 0]
.. .. ..172: [OTHE] pte 6000044f pa 180001000 [level 0]
.. .. ..173: [OTHE] pte 6000084f pa 180002000 [level 0]
.. .. ..174: [OTHE] pte 60000c0f pa 180003000 [level 0]
.. .. ..175: [OTHE] pte 6000104f pa 180004000 [level 0]
.. .. ..176: [OTHE] pte 6000144f pa 180005000 [level 0]
.. .. ..177: [OTHE] pte 600018cf pa 180006000 [level 0]
.. .. ..178: [OTHE] pte 60001c4f pa 180007000 [level 0]
..171: pte 6ffff801 pa 1bfffe000 [level 2]
.. ..85: pte 6fffdc01 pa 1bfff7000 [level 1]
.. .. ..165: [OTHE] pte 67ffe80f pa 19fffa000 [level 0]
.. ..311: pte 6ffff401 pa 1bfffd000 [level 1]
.. .. ..491: [USER] pte 47b094d7 pa 11ec25000 [level 0]
..254: pte 6ffff001 pa 1bfffc000 [level 2]
.. ..98: pte 6fffec01 pa 1bfffb000 [level 1]
.. .. ..69: [USER] pte 47b1f8d7 pa 11ec7e000 [level 0]
..255: pte 6fffe801 pa 1bfffa000 [level 2]
.. ..93: pte 6fffe401 pa 1bfff9000 [level 1]
.. .. ..461: [USER] pte 47bde0d7 pa 11ef78000 [level 0]
```
这感觉看起来像是某个虚拟地址去访问的时候，检索发现其中的某个PTE的值是异常的

https://tmuxai.dev/tmux-capture-pane/
```
Ctrl+b :capture-pane -S -
Ctrl+b :save-buffer filename.txt
```
我们看一下log信息

这一步有可能是一开始页表页中的值就是0导致的错误，很有可能最早的值就不是0？或者linux尝试读的时候失败了？

看起来是读写的时候出了点问题，这一部分大概是在mprotect环节尝试调整修改PTE的时候，但是此处的PTE内容确实发生了一些令我不安的变动
- 最关键的问题是，当我们写的时候，先前我们读出来的值是什么？

通过观察log注意到关键函数需要debug
- 应该是change_protection_range

记住这个，这个确实不好de